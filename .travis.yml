os: linux
dist: trusty
sudo: false
group: beta

matrix:
  include:
    - os: osx
      osx_image: xcode7.2
  
language: node_js
node_js:
  - "6.9.1"

env:
  global:
    secure: "VKNmGHYqSOkXMIPzAI1FvwT+/Zsl81VAXirJYVNP5bT0NUyjs+q3PBZCZYQmsQx8zH59q2XeV7rgfP7a/nU6GRPvE6x47yjiSb7LHp3HYXdxxM+vCmocCnIEhZ36dxcVz6/3McdbsVYJGdm32uA7ZUWpnP4MuiX3YrB3xBYD9lJVwz5Y1LGeMEjBbyJ39+iTFrqLIT4ZIJkXWJfgZeRkaf1X/B1cixN8NnaOVl0rODwh9fKImm2+LhcHDlX3Ma1uSXcb/i33C3ymFiEzrgA+7LL51mzgm6aBhnLV7q+vBzmRJaRa2B/RMFK33BxwSIO9Bec7GjJMuukLXYKRrBPvvV2g5WjcJrd7URTr0Dnfo1N6yI0gGQhzyvj7N046y70OTZq+qyPKJPXKw8BZoda5byTiQx5fhcUTIOoFstPQ3pv7xSro6PWBhIIR5c629w8AW/5Y8EV2Lt+BjS+IKZ0JcRXs8JAoyBt6LNkETUO3g+Uc5+Ar37zwld/IgLutjHhOGa7znibyMuU5X765tG1DS2jGnAvL23JuhFcIKFzNamd470be9k2+ER6U35SpOtvW/ghAV8O1bEXNH2fEaSLZQNfEEUzO10Ec790lCGocI6jjEuDvvqFDrolG5InURoNTp7PbnzQh4vztqOCdw/WpyaZRZY1kU2cm5b8nLeprnko="
    # secure: "bvHVf6PDiY42BUln/KjVbMrNCI24C7MygHg/aPHdio3K6vt7oVGgyjqz2jXpCiwQUwQ61Sd4QOQZZ6oC9aPxbnjmT587zRR9yjoBqNyv9sDVAAEVzKcObrQtX7DMGhANuTmLWImmBKFMJqh9eAlMYq/TqDtRATZGO7PqYCUERVSrvijEDmDLvq2wNavOllEWa2uHD9xXXAuJxNw2Om6hH0Se4LC81Vbyocs+GfjpFO1sMQ7bNO1ODx9T39A/khA+76rDCuZilJy2Mt1RLDrM+TeV/nUDRrUwZns/3XXbOLSeQIIWSF08TvJ6K4Nw0bidCcVwAQN7dhJ01GCKegL2VOfrkUYtVQXKQjzPQyax0AR+Kmzua3q0ujs8unpe0pvbqCMXDXQ77WYmu8vO8Fa/76u1pwJB2g6XY4odRT7AfHgPhxvFK5/eg3I7sWazr/nOszmpPYiOGZk+pZuMBlTdtXoBpQ1QyOFqyivHJO+1ixC0qxbc6ScQ0SAuocNHYjQyGTV+V5E3Z7Io+m+9vaB7tDA/+ePYNELvqFpl092hH/18UZoAVg0btHgy5+00GiAx3k7Cit/S2h52LURlvowpMABB0UHsK6SHc+7MUQYrtITg1ijXmSll2hklBBv2/jMx9R56bfnGpBGe/wGKlSqd3YNwHDEEHyq4eby457Lzpwc="

script: 

  - echo "https://${ACCESS_TOKEN}:x-oauth-basic@github.com"
  - printenv 

  - rm -rf .git
  - rm README.md
  - rm .gitignore
  - git init
  - git remote add origin https://github.com/digihum/imperial-entanglements-app.git
  - git pull origin master

  # print versions
  - node --version
  - npm --version

  # install dependencies
  - npm install

  # build typescript
  - npm run tsc || true

  # copy test db
  - cp blank.sqlite mydb.sqlite

  # copy .env file
  - cp .env.example .env

  # run sql migrations
  - npm run migrate
  - npm run seed

  # ready to test!
  - npm test

  - npm run dist

after_success: 
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://${ACCESS_TOKEN}:x-oauth-basic@github.com" > .git/credentials  
  
  - git config --global user.email "Your email"
  - git config --global user.name "Your Name"
  - git add .
  - git commit -m "Build $($env:APPVEYOR_BUILD_ID)"
  - git push origin master
